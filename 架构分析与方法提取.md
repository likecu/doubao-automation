# 豆包自动化工具集架构分析与有用方法提取

## 1. 项目整体架构

豆包自动化工具集采用双层架构设计：

### 1.1 核心层 - Node.js (基于 Puppeteer)
- 使用 Puppeteer 自动化豆包聊天界面
- 提供浏览器控制、消息发送、文件上传、AI 回复获取等基础功能
- 两个主要实现文件：`doubao_chat_bot.js`（纯文本聊天）和 `test_upload_image.js`（支持图片上传）

### 1.2 API 层 - Python 封装
- 封装 Node.js 脚本，提供更友好的 Python API
- 支持多种功能：纯文本聊天、图片 OCR、屏幕截图 OCR、是/否判断
- 多线程支持，可并发运行多个豆包工具实例

## 2. 核心类与有用方法

### 2.1 Node.js 层 - DoubaoChatBot 类

**文件：`doubao_chat_bot.js` 和 `test_upload_image.js`**

#### 初始化与管理方法
```javascript
// 启动浏览器并导航到豆包聊天页面
async init(headless = true) { ... }

// 检查登录状态
async checkLoginStatus() { ... }

// 关闭浏览器
async close() { ... }
```

#### 消息与文件操作方法
```javascript
// 发送文本消息
async sendMessage(message) { ... }

// 上传文件
async uploadFile(filePath) { ... }

// 发送消息和文件
async sendMessageWithFile(message, filePath) { ... }
```

#### 响应与历史记录方法
```javascript
// 等待并获取 AI 回复
async getAIResponse() { ... }

// 提取聊天历史
async extractChatHistory() { ... }

// 保存聊天历史
async saveChatHistory(filename = 'chat_history.json') { ... }
```

### 2.2 Python 层 - 核心 API 类

#### 2.2.1 DoubaoTextChat (纯文本聊天)

**文件：`doubao_text_chat.py`**

```python
# 调用 Node.js 脚本发送纯文字消息
send_message(message, headless=True) { ... }

# 获取纯文字消息的回复
get_response(message, headless=True) { ... }
```

#### 2.2.2 DoubaoOCR (图片 OCR 识别)

**文件：`doubao_ocr.py`**

```python
# 调用 Node.js 脚本识别图片内容
recognize_image(image_path, question="图里有什么内容？", headless=True) { ... }

# 获取 OCR 识别结果
get_ocr_result(image_path, question="图里有什么内容？", headless=True) { ... }
```

#### 2.2.3 ScreenshotOCR (屏幕截图 OCR)

**文件：`screenshot_ocr.py`**

```python
# 截取当前屏幕
capture_screen(output_path=None) { ... }

# 截取屏幕并识别内容
recognize_screen(output_file=None, question="图里有什么内容？") { ... }
```

#### 2.2.4 DoubaoYesNo (是/否判断)

**文件：`doubao_yes_no.py`**

```python
# 读取文件内容
read_file_content(file_path) { ... }

# 解析回答为 yes 或 no
parse_yes_no(response, debug=False) { ... }

# 判断纯文字问题
judge_text(question, debug=False) { ... }

# 判断文件内容相关问题
judge_file(question, file_path, debug=False) { ... }

# 判断图片内容相关问题
judge_image(question, image_path, debug=False) { ... }

# 统一的判断方法
judge(question=None, file_path=None, image_path=None, debug=False) { ... }
```

#### 2.2.5 DoubaoThread (多线程支持)

**文件：`multi_thread_doubao.py`**

```python
# 线程运行方法，定期执行豆包工具命令
run() { ... }

# 停止线程运行
stop() { ... }
```

## 3. 工具链关系图

```
+-------------------+     +-------------------+     +-------------------+
| Node.js           |     | Python API Layer  |     | End User          |
| DoubaoChatBot     | <-- |                   | <-- |                   |
+-------------------+     +-------------------+     +-------------------+
        ^                       ^                       ^
        |                       |                       |
+-------+-------+     +---------+---------+     +-------+-------+
| doubao_chat_  |     | doubao_text_chat. |     | Command Line    |
| bot.js        |     | py                |     | Interface       |
|               |     |                   |     | (Arguments)     |
| test_upload_  |     | doubao_ocr.py     |     |                 |
| image.js      |     | screenshot_ocr.py |     |                 |
|               |     | doubao_yes_no.py  |     |                 |
+---------------+     | multi_thread_     |     |                 |
                      | doubao.py         |     |                 |
                      +-------------------+     +-----------------+
```

## 4. 关键技术特点

1. **反检测机制**：
   - 修改 navigator.webdriver 为 undefined
   - 移除自动化扩展痕迹
   - 修改浏览器指纹信息
   - 修改 Canvas 指纹
   - 使用真实用户代理

2. **多模态支持**：
   - 纯文本聊天
   - 图片内容识别
   - 屏幕截图识别
   - 文件内容分析

3. **健壮性设计**：
   - 超时处理
   - 错误重试机制
   - 多种发送按钮点击方式
   - 聊天历史持久化

## 5. 使用示例

### 5.1 纯文本聊天
```python
from doubao_text_chat import DoubaoTextChat

text_chat = DoubaoTextChat("doubao_chat_bot.js")
response = text_chat.get_response("你好")
print(response)
```

### 5.2 图片 OCR
```python
from doubao_ocr import DoubaoOCR

ocr = DoubaoOCR("test_upload_image.js")
result = ocr.recognize_image("image.png", "图里有什么？")
print(result["response"])
```

### 5.3 屏幕截图 OCR
```python
from screenshot_ocr import ScreenshotOCR

ocr = ScreenshotOCR("test_upload_image.js")
result = ocr.recognize_screen(output_file="result.txt", question="图里有什么？")
```

### 5.4 是/否判断
```python
from doubao_yes_no import DoubaoYesNo

yes_no = DoubaoYesNo("doubao_chat_bot.js")
# 纯文本判断
result = yes_no.judge(question="地球是圆的吗？")
# 图片判断
result = yes_no.judge(question="图里有猫吗？", image_path="cat.png")
print(result)
```

### 5.5 多线程运行
```python
# 使用命令行
# python multi_thread_doubao.py --threads 3 --question "地球是圆的吗？" --interval 60
```

## 6. 扩展建议

1. **模块化设计**：将 Node.js 脚本合并为一个统一的入口文件，通过参数区分功能
2. **配置管理**：添加配置文件支持，统一管理浏览器设置、超时时间等参数
3. **错误处理**：增强错误处理和日志记录，提高调试效率
4. **并发控制**：改进多线程实现，支持更灵活的任务调度
5. **结果缓存**：添加结果缓存机制，避免重复请求相同内容

## 7. 总结

豆包自动化工具集提供了一套完整的 API 用于与豆包进行交互，支持多种交互方式和使用场景。核心方法包括：

- 浏览器自动化与控制
- 消息发送与接收
- 文件上传与处理
- 图片与屏幕内容识别
- 是/否判断
- 聊天历史管理
- 多线程支持

这些方法可以灵活组合使用，满足各种自动化需求。